{% if account != nil and user.superuser %}

  {% if params.scope == nil or params.scope == "" or params.scope == "opened" %}

    {% assign status          = "opened" %}
    {% assign query_statuses  = "opened escalated" | split: " " %}

  {% elsif params.scope == "closed" %}

    {% assign status          = "closed" %}
    {% assign query_statuses  = "closed" | split: " " %}

  {% endif %}

  {% if user.superuser_level == 1 %}

    {% assign tickets_query = "superuser_level_1_tickets" | db_find: statuses: query_statuses, page: params.page, per_page: params.per_page %}

  {% else %}

    {% if user.closed_ticket_relay_ids != nil and user.closed_ticket_relay_ids.size > 0 %}

      {% assign tickets_query = "relay_tickets" | db_find: relay_ids: user.closed_ticket_relay_ids, statuses: query_statuses, page: params.page, per_page: params.per_page %}

    {% elsif status == "opened" and user.ticket_relay_ids != nil and user.ticket_relay_ids.size > 0 %}

      {% assign tickets_query = "relay_tickets" | db_find: relay_ids: user.ticket_relay_ids, statuses: query_statuses, page: params.page, per_page: params.per_page %}

    {% else %}

      {% assign tickets_query = "superuser_tickets" | db_find: user_id: user._id, statuses: query_statuses, page: params.page, per_page: params.per_page %}

    {% endif %}
  {% endif %}

  {% assign tickets = tickets_query.results %}

  {% if tickets.size > 0 %}

    {% assign relay_ids   = "" %}
    {% assign company_ids = "" %}

    {% for ticket in tickets %}

      {% if ticket.relay_id != nil %}

        {% capture relay_ids %}{{ relay_ids }} {{ ticket.relay_id }}{% endcapture %}

      {% endif %}

      {% if ticket.company_id != nil %}

        {% capture company_ids %}{{ company_ids }} {{ ticket.company_id }}{% endcapture %}

      {% endif %}

    {% endfor %}

    {% assign relay_ids   = relay_ids | lstrip | split: " " | uniq %}
    {% assign company_ids = company_ids | lstrip | split: " " | uniq %}

    {% if relay_ids.size > 0 %}

      {% assign relay_ids = relay_ids | join: "," %}

      {% assign gofetch_project_api_token = project.secrets.gofetch_project_api_token %}

      {% if gofetch_project_api_token == nil %}

        {% assign error = l.no_gofetch_project_api_token %}

      {% else %}

        {% assign relays_response = "relays" | webhook: relay_ids: relay_ids, gofetch_project_api_token: gofetch_project_api_token %}

        {% if relays_response.error != nil %}

          {% capture error %}{{ l.project_api_error }}: {{ relays_response.error }}{% endcapture %}

        {% elsif relays_response.code != 200 %}

          {% capture error %}{{ l.relays_not_found }} {{ relays_response.code }}{% endcapture %}

        {% else %}

          {% assign relays = relays_response.body.documents | to_hash: "_id" %}

        {% endif %}
      {% endif %}
    {% endif %}


    {% if company_ids.size > 0 %}

      {% assign companies_query = "companies" | db_find: company_ids: company_ids %}
      {% assign companies       = companies_query.results | to_hash: "_id" %}

    {% endif %}

  {% endif %}

  {% include "tickets" %}
{% endif %}