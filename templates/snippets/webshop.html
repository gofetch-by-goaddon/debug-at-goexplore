{% if webshop == nil %}
  <h5 class="mb-3">{{ l.headlines.no_webshop }}</h5>
{% else %}
  <style>
    label p {
      margin: 0;
      padding: 0;
    }

    .response.container {
      max-height: 700px;
      overflow: scroll;
      width: calc(100% - 125px);
      width: -moz-calc(100% - 125px);
      width: -webkit-calc(100% - 125px);
    }
  </style>
  <script>
    var converter = new showdown.Converter({simpleLineBreaks: true});
    var addMarkdown;
    addMarkdown = function() {
      $(".markdown").each(function() {
        $(this).html(converter.makeHtml($(this).html()));
      });
    };

    submitRequest = function() {
      $(document).off("submit");
      $(document).on("submit", ".shop-api-form", function(e) {
        e.preventDefault();
        var form_action   = $(this).attr("action");
        var form_method   = $(this).attr("method");
        var url           = $(this).find(":input[name=url]").val();
        $(this).find(":input[type=text], :input[type=hidden]").each(function() {
          if ($(this).val() != "") {
            switch ($(this).data("type")) {
              case "url_part":
                return url = url.replace({% raw %}"{{ "{% endraw %} + $(this).attr("name") + {% raw %}" }}"{% endraw %}, $(this).val());
              case "param":
                if (url.includes("?")) {
                  url += "&";
                } else {
                  url += "?";
                }

                return url += $(this).attr("name") + "=" + $(this).val();
            }
          }
        });
        $.ajax({
          url: form_action,
          type: form_method,
          dataType: "json",
          data: {
            url: url,
            body: null
          },
          success: function(data, status, xhr) {
            var response_json     = JSON.stringify(data.response_json, undefined, 2);
            var highlighted_json  = Prism.highlight(response_json, Prism.languages.json, 'json');
            var pre_div           = $("<pre>").addClass("language-json");
            var code_div          = $("<code>").addClass("language-json").html(highlighted_json);
            pre_div.append(code_div);
            $(this).find(".response-container").append(pre_div);
          },
          error: function (data, status, error) {
            $(this).find(".response-container").append(error);
          }
        });

        return
      });
    };

    $(document).on('turbolinks:load', function() {
      addMarkdown();
      submitRequest();
    })
  </script>
  <h5 class="mb-3">
    {{ l.headlines.webshop }} {{ relay.name }}
  </h5>
  <p>
    <samp>
      {% for identifiable_config_key in relay.identifiable_config_keys %}
        {% if identifiable_config_key != relay.identifiable_config_keys.first %}
          ,&nbsp;
        {% endif %}
        {{ webshop.config[identifiable_config_key] | decrypt }}
      {% endfor %}
    </samp>
  </p>

  {% assign klass_names = "" %}
  {% for endpoint in relay.shop_api.v1.endpoints %}
    {% if endpoint != relay.shop_api.v1.endpoints.first %}
      {% capture klass_names %}{{ klass_names }} {% endcapture %}
    {% endif %}
    {% capture klass_names %}{{ klass_names }}{{ path[0] }}{% endcapture %}
  {% endfor %}
  
  {% assign klass_names = klass_names | split: " " | sort %}
  {% assign tab_id      = "debug_tab" %}

  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" id="{{ tab_id }}" role="tablist">
        {% for klass_endpoints in relay.shop_api.v1.endpoints %}
          {% assign klass_name = klass_endpoints[0] %}
          <li class="nav-item">
            {% if klass_endpoints == relay.shop_api.v1.endpoints.first %}
              {% assign active_bool = " active" %}
              {% assign selected    = "true" %}
            {% else %}
              {% assign active_bool = "" %}
              {% assign selected    = "false" %}
            {% endif %}
            <a class="nav-link{{ active_bool }}" id="{{ klass_name }}-tab" data-toggle="tab" href="#{{ klass_name }}" role="tab" aria-controls="{{ klass_name }}" aria-selected="{{ selected }}">
              {{ klass_name }}
            </a>
          </li>
        {% endfor %}
      </ul>
    </div>
    <div class="card-body">
      <div class="tab-content" id="{{ tab_id }}_content">
        {% for klass_endpoints in relay.shop_api.v1.endpoints %}
          {% assign klass_name = klass_endpoints[0] %}
          {% if klass_endpoints == relay.shop_api.v1.endpoints.first %}
            {% assign show_active = " show active" %}
          {% else %}
            {% assign show_active = "" %}
          {% endif %}
          <div class="tab-pane fade{{ show_active }}" id="{{ klass_name }}" role="tabpanel" aria-labelledby="{{ klass_name }}-tab">
            {% capture accordion_id %}{{ klass_name }}_accordion{% endcapture %}
            <div class="accordion" id="{{ accordion_id }}">
              {% assign show_collapse = " show" %}
              {% for endpoint in klass_endpoints[1] %}

                {% assign url = endpoint.url | replace: project.secrets.gofetch_shop_api_url, "" %}

                {% include "shared/request_id" %}

                {% capture heading_id %}heading_{{ request_id }}{% endcapture %}
                {% capture collapse_id %}collapse_{{ request_id }}{% endcapture %}
                <div class="card border-bottom">
                  <div class="card-header" id="{{ heading_id }}">
                    <h2 class="mb-0">
                      <button class="btn btn-link text-dark" type="button" data-toggle="collapse" data-target="#{{ collapse_id }}" aria-expanded="true" aria-controls="{{ collapse_id }}">
                        {{ endpoint.method | upcase }} {{ endpoint.url | split: "v1" | last }}
                      </button>
                    </h2>
                  </div>

                  <div id="{{ collapse_id }}" class="collapse{{ show_collapse }}" aria-labelledby="{{ heading_id }}" data-parent="#{{ accordion_id }}">
                    <div class="card-body">
                      <div class="markdown">{{ endpoint.description }}</div>
                      <form class="shop-api-form" data-id="{{ request_id }}-form" action="{{ 'tests__create' | path_for: format: 'json' }}" method="post" data-remote="true">
                        <input type="hidden" name="url" value="{{ endpoint.url }}">

                        {% assign url_parts = endpoint.url | split: " " %}
                        {% if url_parts.size > 1 %}
                          {% for url_part in url_parts %}
                            {% if url_part contains "_id" %}
                              {% assign klass_part = url_part | replace: "_id", "" %}
                              {% if klass_name contains klass_part %}
                                <label for="{{ url_part }}">
                                  {{ l.labels.default_1 }} {{ url_part }} {{ l.labels.default_2 }}
                                </label>
                                <div class="input-group mb-4">
                                  <input class="form-control" type="text" data-type="url_part" name="{{ url_part }}" placeholder="{{ l.placeholders.default_1 }} {{ url_part }} {{ l.placeholders.default_2 }}">
                                </div>
                              {% endif %}
                            {% endif %}
                          {% endfor %}
                        {% endif %}

                        {% for param in endpoint.params %}
                          {% if param.key == "webshop_id" %}
                            <input type="hidden" name="webshop_id" data-type="param" value="{{ webshop._id }}">
                          {% else %}
                            <label class="markdown" for="{{ param.key }}">{{ param.description }}</label>
                            <div class="input-group mb-4">
                              <input class="form-control" type="text" name="{{ param.key }}" data-type="param" placeholder="{{ l.placeholders.default_1 }} {{ param.key }} {{ l.placeholders.default_2 }}">
                            </div>
                          {% endif %}
                        {% endfor %}
                        <input class="btn btn-outline-primary mt-3" type="submit" value="{{ l.buttons.test }}">
                        <div class="response-container" data-id="response"></div>
                      </form>
                    </div>
                  </div>
                </div>
                {% assign show_collapse = "" %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}