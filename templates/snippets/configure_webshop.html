{% if error == nil %}
  <h5 class="mb-3">
    {{ l.headlines.intro }} <a href="{{ 'webshops__index' | path_for }}">{{ l.headlines.return }} <i class="fas fa-undo"></i></a>
  </h5>

  {% include "shared/indent_json_input" %}

  <style>
    .input-select2 {
      width: 100%;
    }

    .select2-selection--single, .select2-search__field {
      outline: none;
    }

    .select2-selection__choice {
      margin-bottom: 5px;
      background-color: #e9ecef !important;
    }

    .select2-selection__rendered {
      line-height: 31px !important;
    }
    .select2-container .select2-selection--single {
      height: 35px !important;
    }
    .select2-selection__arrow {
      height: 34px !important;
    }
  </style>

  <script>
    submitRequest = function() {
      $(document).on("submit", ".update-webshop-form", function(e) {
        e.preventDefault();
        var form_action             = $(this).attr("action");
        var form_method             = $(this).attr("method");
        var form_submit             = $(this).find(":input[type=submit]");
        var form_submitting         = $(this).find("[data-type=submitting]");
        var config_input            = $(this).find(":input[name=config]");
        var request_data            = {"config": JSON.parse(config_input.val())};

        form_submit.hide();
        form_submitting.show();

        $.ajax({
          url: form_action,
          type: form_method,
          dataType: "json",
          contentType: "application/json",
          data: JSON.stringify(request_data),
          success: function(data, status, xhr) {
            if (data.success !== undefined) {
              alertify.success(data.success);
            } else if (data.message !== undefined) {
              alertify.message(data.message);
            }

            form_submit.show();
            form_submitting.hide();
          },
          error: function (data, status, error) {
            if (data.responseJSON !== undefined) {
              alertify.error(data.responseJSON.error);
            } else {
              alertify.error("{{ l.messages.internal_error }}");
            }
            form_submit.show();
            form_submitting.hide();
          }
        });

        return
      });
    };

    select2GotAt = function() {
      $(".input-select2-got_at_attribute").select2({
        width: "100%",
        placeholder: "{{ l.placeholders.got_at_attribute }}",
        multiple: false,
        allowClear: false,
        tags: false,
        sorter: function(data) {
          return data.sort(function(a, b) {
            a = a.text.toLowerCase();
            b = b.text.toLowerCase();
            if (a > b) {
              return 1;
            } else if (a < b) {
              return -1;
            }
            return 0;
          });
        }
      });
      
      $(".input-got-at").on("select2:select", function(e) {
        var id, option;
        id = e.params.data.id;
        option = $(e.target).children("[value='" + id + "']");
        option.detach();
        return $(e.target).append(option).change();
      });
    };

  $(document).on('turbolinks:load', function() {
    submitRequest();
    select2GotAt();
  })
  </script>

  <p><b>{{ l.headers.config }}</b></p>
  <p>{{ l.explainers.config }}</p>

  {% assign config = nil | new_hash %}

  {% for kv in webshop.config %}

    {% assign klassname = kv[1] | klassname %}

    {% if klassname == "String" %}

      {% assign decrypted = kv[1] | decrypt %}
      {% assign config    = config | push_to_hash: kv[0], decrypted %}

    {% else %}

      {% assign config    = config | push_to_hash: kv[0], kv[1] %}

    {% endif %}
  {% endfor %}

  <form class="update-webshop-form mb-4" action="{{ 'webshops__update' | path_for: id: webshop._id, format: 'json' }}" method="patch" data-remote="true">

    <div class="json-container">
      <textarea class="border" name="config">{{ config | json }}</textarea>
    </div>

    <input class="btn btn-outline-primary mt-3 btn-fullwidth" type="submit" value="{{ l.buttons.submit }}">
    <button class="btn btn-outline-primary mt-3 btn-fullwidth disabled" data-type="submitting" disabled="" style="display: none;">{{ l.buttons.submitting }}</button>

  </form>

  <p><b>{{ l.headers.reset }}</b></p>
  <p>
    {{ l.explainers.reset.p1 }} <a href="https://goaddon.com/en/addons/5b9ff6463ab42f43522b30cf/manage#page=integrations&query=%7B%22filter%22%3A%22{{ relay.name | downcase }}%22%7D" target="_blank">{{ relay.name }} <i class="fas fa-external-link-alt"></i></a>. {{ l.explainers.reset.p2 }}.
  </p>

  <form class="reset-got-at-form" action="{{ 'webshops__update' | path_for: id: webshop._id, format: 'json' }}" method="patch" data-remote="true">
    <b><label for="got_at_attribute">{{ l.labels.got_at_attribute }}</label></b>
    <table>
      <tr>
        <td width="100%">
          <div class="form-group">
            <select name="got_at_attribute" class="form-control input-select2 input-select2-got_at_attribute" multiple>
              <option value="" label=" "></option>
              {% for attribute in webshop %}
                {% capture got_at %}{{ attribute[0] | slice: 0, 3 }}{{ attribute[0] | slice: -3, 3 }}{% endcapture %}
                {% if got_at == "got_at" %}
                  {% assign attribute_name = attribute[0] %}
                  <option value="{{ attribute_name }}">{{ l.attributes[attribute_name] }}</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
        </td>
        <td style="vertical-align: top;">
          <input type="submit" class="btn btn-outline-primary ml-1" value="{{ l.buttons.reset }}">
        </td>
      </tr>
    </table>
  </form>
{% endif %}