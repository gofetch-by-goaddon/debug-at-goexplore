{% if error != nil %}
  <h5 class="mb-3">
    {{ l.headlines.error }} <a href="{{ 'tickets__index' | path_for }}">{{ l.headlines.return }}<i class="fas fa-undo"></i></a>
  </h5>
  <p>{{ error }}</p>
{% else %}

  <style>
    .submit-link:hover {
      text-decoration: underline;
    }

    .dropdown-link:focus, .submit-link:focus {
      outline: none;
    }
  </style>

  {% include "shared/indent_json_pre" %}

  <h5 class="mb-3">
    {{ l.headlines.intro }} <a href="{{ 'tickets__index' | path_for }}">{{ l.headlines.return }} <i class="fas fa-undo"></i></a>
  </h5>

  <table class="table">
    <tbody>
      {% assign now                 = "now" | date: "%Y-%m-%d %H:%M:%S" | parse_time %}
      {% assign status_field_names  = "opened_at escalated_at closed_at re_opened_at" | split: " " %}
      {% assign assign timeline     = "" | split: " " %}

      {% for status_field_name in status_field_names %}

        {% if ticket[status_field_name] != nil %}

          {% assign status_field = nil | new_hash %}
          {% assign status_field = status_field | push_to_hash: "name", status_field_name %}
          {% assign status_field = status_field | push_to_hash: "value", ticket[status_field_name] %}

          {% assign timeline = timeline | push_to_array: status_field %}

        {% endif %}

      {% endfor %}

      {% assign timeline            = timeline | sort: "value" %}
      {% assign field_names         = "" | split: " " %}

      {% for t in timeline %}

        {% assign field_names = field_names | push_to_array: t.name %}

      {% endfor %}

      {% assign input_field_names   = "mail_address phone comments admin_url admin_username admin_password ftp_host ftp_username ftp_password ssh_address ssh_password" | split: " " %}
      {% assign field_names         = field_names | concat: input_field_names %}

      <tr>
        <td width="1" class="text-nowrap">
          <b>{{ l.headers.status }}:</b>
        </td>
        <td>
          {% assign ticket_status = ticket.status %}
          {{ l.statuses[ticket_status] }}
        </td>
      </tr>

      {% if relay != nil %}
        <tr>
          <td width="1" class="text-nowrap">
            <b>{{ l.headers.relay }}:</b>
          </td>
          <td>
            {{ relay.name }}
          </td>
        </tr>
      {% endif %}

      {% if ticket.webshop_id != nil %}
        <tr>
          <td width="1" class="text-nowrap">
            <b>{{ l.headers.webshop }}:</b>
          </td>
          <td>
            <a href="{{ 'webshops__edit' | path_for: id: ticket.webshop_id }}" target="_blank">{{ l.informations.edit_webshop }} <i class="fas fa-external-link-alt"></i></a> {{ l.informations.or }} <a href="{{ 'webshops__show' | path_for: id: ticket.webshop_id }}" target="_blank">{{ l.informations.show_webshop }} <i class="fas fa-external-link-alt"></i></a>
          </td>
        </tr>
      {% endif %}

      {% if ticket.superuser_id != nil or ticket.status == "escalated" %}
        <tr>
          <td width="1" class="text-nowrap">
            <b>{{ l.headers.assignee }}:</b>
          </td>
          <td>
            {% if ticket.superuser_id == user._id %}
              {{ l.informations.assigned_to_you }}
            {% else %}
              {% for superuser in superusers %}
                {% if ticket.superuser_id == superuser._id %}
                  {{ superuser.email }}
                {% endif %}
              {% endfor %}
            {% endif %}
            {% if ticket.status == "escalated" %}
              <span class="badge badge-secondary">{{ l.informations.escalated }}</span>
            {% endif %}
          </td>
        </tr>
      {% endif %}

      <tr>
        <td width="1" class="text-nowrap">
          <b>{{ l.headers.options }}:</b>
        </td>
        <td>

          {% assign action_count  = 0 %}
          {% assign action_number = 0 %}

          {% if ticket.superuser_id != user._id %}

            {% assign action_count  = action_count | plus: 1 %}
            {% assign action_number = action_number | plus: 1 %}

            <form class="d-inline" action="{{ 'tickets__update' | path_for: id: ticket._id, format: 'js' }}" method="patch" data-remote="true">
              <input type="hidden" name="superuser_id" value="{{ user._id }}"><input type="submit" class="submit-link d-inline border-0 py-0 px-0 text-primary bg-white" value="{{ l.update_status.links.claim }}">,
            </form>

          {% endif %}

          {% if ticket.status == "closed" %}

            {% assign statuses      = "re_opened" | split: " " %}

          {% elsif ticket.status == "escalated" %}

            {% assign statuses      = "de_escalated closed" | split: " " %}

          {% else %}

            {% assign statuses      = "closed" | split: " " %}

            {% if status.escalated_at != nil %}
              {% assign statuses = statuses | push_to_array: "de_escalated" %}
            {% else %}
              {% assign statuses = statuses | push_to_array: "escalated" %}
            {% endif %}

          {% endif %}

          {% for status in statuses %}
            {% if ticket.status != status %}
              {% assign action_count = action_count | plus: 1 %}
            {% endif %}
          {% endfor %}

          {% assign superusers_count = 0 %}
          {% for superuser in superusers %}
            {% if superuser._id != user._id and superuser._id != ticket.superuser_id %}
              {% assign superusers_count = superusers_count | plus: 1 %}
            {% endif %}
          {% endfor %}

          {% assign second_last_action_number = action_count | minus: 1 %}

          {% for status in statuses %}
            {% if ticket.status != status %}

              {% assign action_number = action_number | plus: 1 %}

              {% if action_count == 1 or action_number == action_count %}
                {% if superusers_count == 0 %}

                  {% assign append_string = "" %}

                {% else %}

                  {% assign append_string = l.update_status.append_strings.or %}

                {% endif %}
              {% elsif action_number == second_last_action_number %}
                {% if superusers_count == 0 %}

                  {% assign append_string = l.update_status.append_strings.or %}

                {% else %}

                  {% assign append_string = ", " %}

                {% endif %}                
              {% else %}

                {% assign append_string = ", " %}

              {% endif %}

              {% if action_number == 1 %}
                {% assign link_text = l.update_status.links[status] | capitalize %}
              {% else %}
                {% assign link_text = l.update_status.links[status] %}
              {% endif %}

              <form class="d-inline" action="{{ 'tickets__update' | path_for: id: ticket._id, format: 'js' }}" method="patch" data-remote="true">
                <input type="hidden" name="status" value="{{ status }}"><input type="submit" class="submit-link d-inline border-0 py-0 px-0 text-primary bg-white" value="{{ link_text }}">{{ append_string }}
              </form>
            {% endif %}
          {% endfor %}

          {% if superusers_count > 0 %}
            <div class="dropright d-inline">
              <button class="dropdown-link d-inline border-0 py-0 px-0 text-primary bg-white dropdown-toggle" type="button" id="assign_ticket" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                {% if ticket.superuser_id == nil %}
                  {{ l.assign.assign }}
                {% else %}
                  {{ l.assign.reassign }}
                {% endif %}
              </button>
              <div class="dropdown-menu" aria-labelledby="assign_ticket">
                <h6 class="dropdown-header px-3">{{ l.assign.header }}</h6>
                <div class="dropdown-divider mb-1"></div>
                {% for superuser in superusers %}
                  {% if superuser._id != user._id and superuser._id != ticket.superuser_id %}

                    <form action="{{ 'tickets__update' | path_for: id: ticket._id, format: 'js' }}" method="patch" data-remote="true">
                      <input type="hidden" name="superuser_id" value="{{ superuser._id }}"><input type="submit" class="px-3 btn btn-link" value="{{ superuser.email }}">
                    </form>

                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% endif %}

        </td>
      </tr>

      {% for field_name in field_names %}
        {% if ticket[field_name] != nil and ticket[field_name] != "" %}
          <tr>
            <td width="1" class="text-nowrap">
              <b>{{ l.headers[field_name] }}:</b>
            </td>
            <td>
              {% if status_field_names contains field_name %}
                <span title="{{ ticket[field_name] | i18n_l: 'wday_date_hours_minutes' | capitalize }}">
                  {{ ticket[field_name] | time_distance_in_words: now }} {{ l.informations.ago }}
                </span>
              {% else %}
                {{ ticket[field_name] | decrypt }}
              {% endif %}
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>

  <form action="{{ 'tickets__update' | path_for: id: ticket._id, format: 'js' }}" method="patch" data-remote="true">
    <label class="mb-1">
      <b>{{ l.message.label }}</b>
    </label>
    <textarea name="message" placeholder="{{ l.message.placeholder }}" rows="3" class="form-control"></textarea>
    <input type="submit" class="btn btn-outline-primary mt-3 btn-fullwidth" value="{{ l.message.submit }}">
  </form>

  <div class="accordion" id="log_accordion">
     <div class="card border">
        <div class="card-header p-1" id="card_log">
          <h5 class="mb-0">
            <button aria-controls="collapse_card_log" aria-expanded="false" class="btn btn-link collapsed" data-target="#collapse_card_log" data-toggle="collapse" type="button">
              <div class="text-dark">
                {{ l.log.header }}
              </div>
            </button>
          </h5>
        </div>
        <div aria-labelledby="card_log" class="collapse show" data-parent="#log_accordion" id="collapse_card_log" style="">
          <div class="card-body">
            <table class="table">
              <thead>
                <tr>
                  <th class="border-bottom-0">{{ l.log_headers.event }}</th>
                  <th class="border-bottom-0 text-right">{{ l.log_headers.time }}</th>
                </tr>
              </thead>
              <tbody>

                {% if ticket.log != nil %}

                  {% assign log = ticket.log | reverse %}

                  {% for log_entry in log %}

                    <tr>
                      <td>
                        {% if log_entry.superuser_id != nil %}

                          {{ l.log_body.superuser_id }}

                          {% assign superuser_matched = false %}

                          {% for superuser in superusers %}

                            {% if superuser._id == log_entry.superuser_id %}

                              {{ superuser.email }}

                              {% assign superuser_matched = true %}

                            {% endif %}

                          {% endfor %}

                          {% unless superuser_matched %}

                            {{ log_entry.superuser_id }}

                          {% endunless %}
                        
                        {% elsif log_entry.status != nil %}
                          {% assign log_entry_status = log_entry.status %}
                          {{ l.log_body.statuses[log_entry_status] }}
                        {% endif %}
                      </td>
                      <td class="text-right">
                        <span title="{{ log_entry.time | i18n_l: 'wday_date_hours_minutes' | capitalize }}">
                          {{ log_entry.time | time_distance_in_words: now }} {{ l.informations.ago }}
                        </span>
                      </td>
                    </tr>

                  {% endfor %}
                {% endif %}

              </tbody>
            </table>
           </div>
        </div>
     </div>
  </div>

  {% if auth != nil %}
    {% assign auth_field_names = "webshop_config setup_config error log" | split: " " %}

    {% for auth_field_name in auth_field_names %}
      {% if auth[auth_field_name] != nil %}
        <p class="mt-4">
          <b>{{ l.auth_headlines[auth_field_name] }}</b>
        </p>
        <p>{{ l.auth_explainers[auth_field_name] }}:</p>

        {% if auth_field_name == "error" %}

          {% assign auth_error = "" | split: " " %}

          {% for auth_e in auth.error %}

            {% assign encrypted_hash = auth_e %}
            {% include "shared/decrypt_hash" %}

            {% assign auth_error = auth_error | push_to_array: decrypted_hash %}

          {% endfor %}

          {% assign decrypted_hash = auth_error %}

        {% else %}

          {% assign encrypted_hash = auth[auth_field_name] %}
          {% include "shared/decrypt_hash" %}

        {% endif %}

        <div class="json-pre-container">
          <div class="json-sample" style="display: none;">{{ decrypted_hash | json }}</div>
          <pre class="language-json"><code class="language-json"></code></pre>
        </div>
      {% endif %}
    {% endfor %}
  {% endif %}
{% endif %}